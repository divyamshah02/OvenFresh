<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - ShopAdmin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/admin/styles.css">
    <link rel="stylesheet" href="/static/css/loader.css">

    <style>
        .order-timeline {
            position: relative;
            padding-left: 30px;
        }

        .order-timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e9ecef;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -23px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6c757d;
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px #e9ecef;
        }

        .timeline-item.active::before {
            background: #28a745;
            box-shadow: 0 0 0 2px #28a745;
        }

        .timeline-item.current::before {
            background: #ffc107;
            box-shadow: 0 0 0 2px #ffc107;
        }

        .order-status-badge {
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            border-radius: 50px;
        }

        .delivery-person-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delivery-person-card:hover {
            border-color: var(--bs-primary);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .delivery-person-card.selected {
            border-color: var(--bs-primary);
            background-color: rgba(var(--bs-primary-rgb), 0.05);
        }

        .order-items-table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .print-section {
            display: none;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-section {
                display: block !important;
            }
            
            .container-fluid {
                margin: 0;
                padding: 0;
            }
        }

        .kot-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .kot-items {
            margin: 20px 0;
        }

        .kot-footer {
            margin-top: 30px;
            border-top: 1px solid #000;
            padding-top: 10px;
        }

        .stat-card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .icon-container {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: rgba(var(--bs-primary-rgb), 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bs-primary);
            font-size: 1.5rem;
        }

        .customer-info-card .icon-container {
            background-color: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .payment-info-card .icon-container {
            background-color: rgba(240, 147, 251, 0.1);
            color: #f093fb;
        }

        .delivery-info-card .icon-container {
            background-color: rgba(79, 172, 254, 0.1);
            color: #4facfe;
        }

        .order-summary-card .icon-container {
            background-color: rgba(67, 233, 123, 0.1);
            color: #43e97b;
        }
    </style>
</head>

<body class="ovenfresh-theme">
    <div id="loader" class="loader-container">
        <div class="loader"></div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            {% include 'admin/admin-nav.html' %}

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Header -->
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <div class="d-flex align-items-center">
                        <button class="navbar-toggler d-md-none collapsed me-3" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div>
                            <h1 class="h2">Order Details</h1>
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb mb-0">
                                    <li class="breadcrumb-item"><a href="/admin-dashboard/">Dashboard</a></li>
                                    <li class="breadcrumb-item"><a href="/admin-all-orders/">Orders</a></li>
                                    <li class="breadcrumb-item active" id="breadcrumb-order-id">Order Details</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button class="btn btn-outline-primary" onclick="downloadKOT()">
                                <i class="fas fa-download me-2"></i>Download KOT
                            </button>
                            <!-- <button class="btn btn-outline-success" onclick="printKOT()">
                                <i class="fas fa-print me-2"></i>Print KOT
                            </button> -->
                            <button class="btn btn-primary" onclick="updateOrderStatus()">
                                <i class="fas fa-save me-2"></i>Update Order
                            </button>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i> Admin
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Order Header Card -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h2 class="mb-1" id="order-title">Order #</h2>
                                <p class="text-muted mb-0" id="order-date"></p>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <span class="order-status-badge" id="order-status-badge"></span>
                                <div class="mt-2">
                                    <select class="form-select d-inline-block w-auto" id="status-select">
                                        <option value="placed">Placed</option>
                                        <!-- <option value="confirmed">Confirmed</option> -->
                                        <option value="preparing">Preparing</option>
                                        <option value="ready">Ready for Delivery</option>
                                        <option value="out_for_delivery">Out for Delivery</option>
                                        <option value="delivered">Delivered</option>
                                        <!-- <option value="cancelled">Cancelled</option> -->
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary mt-2" id="new_update_btn" onclick="confirmStatusUpdate()" style="display: none;">Update Status</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Information Cards -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card stat-card customer-info-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-subtitle mb-0">Customer Information</h6>
                                    <div class="icon-container">
                                        <i class="fas fa-user"></i>
                                    </div>
                                </div>
                                <div id="customer-info">
                                    <!-- Customer info will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card stat-card payment-info-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-subtitle mb-0">Payment Information</h6>
                                    <div class="icon-container">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                </div>
                                <div id="payment-info">
                                    <!-- Payment info will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card stat-card delivery-info-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-subtitle mb-0">Delivery Information</h6>
                                    <div class="icon-container">
                                        <i class="fas fa-truck"></i>
                                    </div>
                                </div>
                                <div id="delivery-info">
                                    <!-- Delivery info will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card stat-card order-summary-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="card-subtitle mb-0">Order Summary</h6>
                                    <div class="icon-container">
                                        <i class="fas fa-calculator"></i>
                                    </div>
                                </div>
                                <div id="order-summary">
                                    <!-- Order summary will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items and Timeline -->
                <div class="row">
                    <div class="col-lg-8">
                        <!-- Order Items -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>Order Items
                                </h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="printKOT()">
                                    <i class="fas fa-print me-1"></i> Print Items
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle order-items-table">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Variation</th>
                                                <th>Quantity</th>
                                                <th>Price</th>
                                                <th>Discount</th>
                                                <th>Total</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="order-items-tbody">
                                            <!-- Order items will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-camera me-2"></i>Delivery Photos & Extra Costs
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Extra Cost Section -->
                                    <div class="col-md-4 mb-4 mb-md-0">
                                        <div class="border rounded p-3 h-100">
                                            <h6 class="mb-3">Extra Charges</h6>
                                            <hr>
                                            <div class="d-flex justify-content-between fw-bold">
                                                <span>Total Extra Cost:</span>
                                                <span>₹<span id="total-extra-cost">0.00</span></span>
                                            </div>
                                            <div class="d-flex justify-content-between fw-bold">
                                                <span>Cost reason:</span>
                                                <span id="mode-transport"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Delivery Photos Section -->
                                    <div class="col-md-8">
                                        <h6 class="mb-3">Delivery Proof Photos</h6>
                                        <div class="row g-2" id="delivery-photos-container">
                                            <!-- Photos will be populated here -->
                                            <div class="col-12 text-center py-4">
                                                <div class="text-muted">
                                                    <i class="fas fa-images fa-2x mb-2"></i>
                                                    <p>No delivery photos available</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Delivery Person Assignment -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-motorcycle me-2"></i>Assign Delivery Person
                                </h5>
                                <button class="btn btn-sm btn-outline-secondary" id="refreshDeliveryBtn">
                                    <i class="fas fa-sync-alt me-1"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="row" id="delivery-persons-container">
                                    <!-- Delivery persons will be populated here -->
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="openCommissionModal()">
                                        <i class="fas fa-user-check me-2"></i>Assign Selected Person
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <!-- Order Timeline -->
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-clock me-2"></i>Order Timeline
                                </h5>
                                <span class="badge bg-primary">Status Updates</span>
                            </div>
                            <div class="card-body">
                                <div class="order-timeline" id="order-timeline">
                                    <!-- Timeline will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Special Instructions -->
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-sticky-note me-2"></i>Special Instructions
                                </h5>
                                <span class="badge bg-warning">Notes</span>
                            </div>
                            <div class="card-body">
                                <div id="special-instructions">
                                    <!-- Special instructions will be populated here -->
                                </div>
                                <hr>
                                <div>
                                    <label for="admin-notes" class="form-label">Admin Notes</label>
                                    <textarea class="form-control" id="admin-notes" rows="3" placeholder="Add internal notes..."></textarea>
                                    <div class="d-flex justify-content-end mt-2">
                                        <button class="btn btn-sm btn-outline-primary" id="saveNotesBtn">
                                            <i class="fas fa-save me-1"></i> Save Notes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Commission Modal -->
    <div class="modal fade" id="commissionModal" tabindex="-1" aria-labelledby="commissionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commissionModalLabel">
                Enter Commission Amount
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <label for="commissionInput" class="form-label">Commission (₹)</label>
                <input type="number" step="0.01" inputmode="decimal" class="form-control" id="commissionInput" placeholder="Enter amount in rupees" min="0">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCommissionBtn" onclick="assignDeliveryPerson()">
                Confirm Driver & Commission
                </button>
            </div>
            </div>
        </div>
    </div>

    <!-- Corporate Order Modal -->
    <div class="modal fade" id="corporateOrderModal" tabindex="-1" aria-labelledby="corporateOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="corporateOrderModalLabel">Corporate Order Pricing</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> Adjust the subtotal value. Tax is automatically calculated at 18% but can be manually overridden if needed.
                    </div>
                    
                    <!-- Pricing Controls -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Original Pricing</h6>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Subtotal:</span>
                                        <span id="original-subtotal">₹${orderData.subtotal.toFixed(2)}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Tax (18%):</span>
                                        <span id="original-tax">₹${orderData.tax_amount.toFixed(2)}</span>
                                    </div>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>Total:</span>
                                        <span id="original-total">₹${orderData.total_amount.toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Corporate Pricing</h6>
                                    <div class="mb-2">
                                        <label for="corporate-subtotal-input" class="form-label">Subtotal</label>
                                        <input type="number" step="0.01" class="form-control" id="corporate-subtotal-input" 
                                            value="${orderData.subtotal.toFixed(2)}" placeholder="Enter subtotal" min="0">
                                    </div>
                                    <div class="mb-2">
                                        <label for="corporate-tax-input" class="form-label">Tax Amount</label>
                                        <div class="input-group">
                                            <input type="number" step="0.01" class="form-control" id="corporate-tax-input" 
                                                value="${(orderData.subtotal * 0.18).toFixed(2)}" placeholder="Enter tax amount" min="0">
                                            <span class="input-group-text">18%</span>
                                            <button class="btn btn-outline-secondary" type="button" id="reset-tax-btn" title="Reset to 18%">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>New Total:</span>
                                        <span id="corporate-total-preview">₹${(orderData.subtotal + (orderData.subtotal * 0.18)).toFixed(2)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Order Items Table (Read-only) -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Variation</th>
                                    <th>Quantity</th>
                                    <th>Price (₹)</th>
                                    <th>Discount (₹)</th>
                                    <th>Total (₹)</th>
                                </tr>
                            </thead>
                            <tbody id="corporate-order-items-tbody">
                                <!-- Corporate order items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveCorporateOrderChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- KOT Print Section (Hidden) -->
    <div class="print-section" id="kot-print-section">
        <div class="kot-header">
            <h2>KITCHEN ORDER TICKET (KOT)</h2>
            <p><strong>OvenFresh Bakery</strong></p>
            <p>Order ID: <span id="kot-order-id"></span> | Date: <span id="kot-date"></span></p>
        </div>

        <div class="row">
            <!-- <div class="col-6">
                <h5>Customer Details:</h5>
                <div id="kot-customer-details"></div>
            </div> -->
            <div class="col-12">
                <h5>Delivery Details:</h5>
                <div id="kot-delivery-details"></div>
            </div>
        </div>

        <div class="kot-items">
            <h5>Order Items:</h5>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Variation</th>
                        <th>Qty</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="kot-items-tbody">
                </tbody>
            </table>
        </div>

        <div class="kot-footer">
            <div class="row">
                <div class="col-6">
                    <p><strong>Special Instructions:</strong></p>
                    <div id="kot-special-instructions"></div>
                </div>
                <div class="col-6">
                    <p><strong>Kitchen Notes:</strong></p>
                    <div id="kot-kitchen-notes"></div>
                </div>
            </div>
            <div class="mt-3">
                <p><strong>Prepared by:</strong> _________________ <strong>Time:</strong> _________________</p>
                <p><strong>Quality Check:</strong> _________________ <strong>Time:</strong> _________________</p>
            </div>
        </div>
    </div>

    <!-- Update Status Modal -->
    <div class="modal fade" id="updateStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Order Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="modal-status-select" class="form-label">New Status</label>
                        <select class="form-select" id="modal-status-select">
                            <option value="placed">Placed</option>
                            <!-- <option value="confirmed">Confirmed</option> -->
                            <option value="preparing">Preparing</option>
                            <option value="ready">Ready for Delivery</option>
                            <option value="out_for_delivery">Out for Delivery</option>
                            <option value="delivered">Delivered</option>
                            <!-- <option value="cancelled">Cancelled</option> -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="status-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="status-notes" rows="3" placeholder="Add notes about this status change..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="confirmStatusUpdate()">Update Status</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999;"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="/static/js/loader.js"></script>
    <script src="/static/js/api_caller.js"></script>
    <script src="/static/js/admin/admin_order_detail.js"></script>

    <script>
        const csrfToken = "{{ csrf_token }}";
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get("order_id");
        
        InitializeAdminOrderDetail(
            csrfToken,
            orderId,
            "/order-api/admin-order-detail-api/",
            "/order-api/admin-delivery-persons-api/",
            "/order-api/admin-update-order-status-api/",
            "/order-api/admin-assign-delivery-api/"
        );
        toggle_loader();
    </script>
</body>

</html>
