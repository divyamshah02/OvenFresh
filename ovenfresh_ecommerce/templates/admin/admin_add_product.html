<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Product - ShopAdmin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="/static/css/admin/styles.css">
</head>
<body class="ovenfresh-theme">
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
        <div class="position-sticky">
          <div class="brand-container mb-4 p-3 d-flex justify-content-between align-items-center">
            <h2 class="brand-name">ShopAdmin</h2>
            <button id="theme-toggle" class="btn btn-sm theme-toggle">
              <i class="fas fa-sun"></i>
            </button>
          </div>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="#dashboard-section">
                <i class="fas fa-tachometer-alt me-2"></i>
                Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#products-section">
                <i class="fas fa-box me-2"></i>
                Products
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#categories-section">
                <i class="fas fa-tags me-2"></i>
                Categories
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#orders-section">
                <i class="fas fa-shopping-cart me-2"></i>
                Orders
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#customers-section">
                <i class="fas fa-users me-2"></i>
                Customers
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#forms-section">
                <i class="fas fa-edit me-2"></i>
                Forms
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#ui-elements-section">
                <i class="fas fa-palette me-2"></i>
                UI Elements
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#modals-section">
                <i class="fas fa-window-restore me-2"></i>
                Modals
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Main content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <div class="d-flex align-items-center">
            <button class="navbar-toggler d-md-none collapsed me-3" type="button" data-bs-toggle="collapse" data-bs-target="#sidebar">
              <span class="navbar-toggler-icon"></span>
            </button>
            <h1 class="h2">Add Product</h1>
          </div>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown">
                <i class="fas fa-user-circle me-1"></i> Admin
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">Profile</a></li>
                <li><a class="dropdown-item" href="#">Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#">Logout</a></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Product Form Section -->
        <section id="product-form-section" class="mb-5">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Product Information</h5>
              <button type="button" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-question-circle me-1"></i> Help
              </button>
            </div>
            <div class="card-body">
              <form id="productForm">
                <div class="row mb-3">
                  <div class="col-md-6 mb-3">
                    <label for="productTitle" class="form-label">Product Title <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="productTitle" placeholder="Enter product title" required>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="productPhoto" class="form-label">Product Photo URL <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="productPhoto" placeholder="Enter photo URL" value="https://www.dynamiclabz.net/static/assets/images/resource/livechat%20(1).png" required>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="productDesc" class="form-label">Product Description <span class="text-danger">*</span></label>
                  <textarea class="form-control" id="productDesc" rows="4" placeholder="Enter description" required></textarea>
                </div>
                <div class="row mb-3">
                  <div class="col-md-6 mb-3">
                    <label for="categorySelect" class="form-label">Category <span class="text-danger">*</span></label>
                    <select class="form-select" id="categorySelect" required>
                      <option value="" disabled selected>-- Select Category --</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="subCategorySelect" class="form-label">Sub-Category <span class="text-danger">*</span></label>
                    <select class="form-select" id="subCategorySelect" required>
                      <option value="" disabled selected>-- Select Sub-Category --</option>
                    </select>
                  </div>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button type="button" id="submitProductBtn" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Create Product
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Existing Variations Section -->
          <div id="existingVariationsContainer" class="card mb-4" style="display: none;">
            <div class="card-header">
              <h5 class="mb-0">Existing Variations</h5>
            </div>
            <div class="card-body">
              <div id="variationList" class="mb-3">
                <!-- Variations will be loaded here -->
              </div>
            </div>
          </div>

          <!-- Variation Form Section -->
          <div id="variationSection" class="card mb-4" style="display: none;">
            <div class="card-header">
              <h5 id="product_variation_heading" class="mb-0">Add Product Variation</h5>
            </div>
            <div class="card-body">
              <form id="variationForm">
                <div class="row mb-3">
                  <div class="col-md-4 mb-3">
                    <label for="weight" class="form-label">Weight <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="weight" placeholder="e.g. 500g" required>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="actualPrice" class="form-label">Actual Price <span class="text-danger">*</span></label>
                    <div class="input-group">
                      <span class="input-group-text">₹</span>
                      <input type="number" class="form-control" id="actualPrice" placeholder="e.g. 1000" required>
                    </div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="discountedPrice" class="form-label">Discounted Price <span class="text-danger">*</span></label>
                    <div class="input-group">
                      <span class="input-group-text">₹</span>
                      <input type="number" class="form-control" id="discountedPrice" placeholder="e.g. 800" required>
                    </div>
                  </div>
                </div>
                <input type="hidden" id="productVariationId" value="">

                <h5 class="mb-3 mt-4">Variation Availability</h5>
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Availability Tools</h6>
                  </div>
                  <div class="card-body">
                    <div class="row mb-3">
                      <div class="col-md-6 mb-2">
                        <button type="button" class="btn btn-outline-primary w-100" onclick="selectAllTimeslots()">
                          <i class="fas fa-check-square me-1"></i> Available on all timeslots & pincodes
                        </button>
                      </div>
                      <div class="col-md-6 mb-2">
                        <div class="input-group">
                          <input type="number" id="universalCharge" class="form-control" placeholder="Set All Charges">
                          <button type="button" class="btn btn-outline-primary" onclick="applyUniversalCharge()">
                            <i class="fas fa-sync me-1"></i> Apply to All
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-8 mb-2">
                        <div class="input-group">
                          <input type="number" id="baseCharge" class="form-control" placeholder="Base">
                          <input type="number" id="stepCharge" class="form-control" placeholder="Step">
                          <button type="button" class="btn btn-outline-primary" onclick="applyStepCharges()">
                            <i class="fas fa-sort-numeric-up me-1"></i> Step Up Charges
                          </button>
                        </div>
                      </div>
                      <div class="col-md-4 mb-2">
                        <div class="input-group">
                          <select id="disableTimeslot" class="form-select">
                            <option disabled selected>Select Timeslot to Disable</option>
                            <!-- Timeslots will be loaded here -->
                          </select>
                          <button type="button" class="btn btn-outline-danger" onclick="disableTimeslotForAll()">
                            <i class="fas fa-ban me-1"></i> Disable
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div id="pincodeAvailability" class="mb-3">
                  <!-- Pincode availability will be loaded here -->
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                  <button type="button" id="submitVariationBtn" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Add Variation
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/api_caller.js"></script>
  <script src="/static/js/admin/admin_add_product.js"></script>
  <script>
    // Theme toggle functionality
    document.getElementById('theme-toggle').addEventListener('click', function() {
      const icon = this.querySelector('i');
      if (icon.classList.contains('fa-sun')) {
        icon.classList.replace('fa-sun', 'fa-moon');
        document.body.classList.remove('ovenfresh-theme');
        document.body.classList.add('dark-theme');
      } else {
        icon.classList.replace('fa-moon', 'fa-sun');
        document.body.classList.remove('dark-theme');
        document.body.classList.add('ovenfresh-theme');
      }
    });

    // Show variation section if product_id exists in URL
    const urlParamsHtml = new URLSearchParams(window.location.search);
    if (urlParamsHtml.get("product_id")) {
      document.getElementById("variationSection").style.display = "";
      document.getElementById("existingVariationsContainer").style.display = "";
    }

    // Initialize with CSRF token
    const csrfToken = "{{ csrf_token }}";
    AdminAddProduct(
      csrfToken,
      "{% url 'category-list' %}",
      "{% url 'sub-category-list' %}",
      "{% url 'pincode-timeslots-list' %}",
      "{% url 'product-list' %}",
      "{% url 'product-variation-list' %}",
      "{% url 'availability-charges-list' %}"
    );

    // Enhance the UI for pincode availability
    function enhancePincodeUI() {
      const pincodeContainer = document.getElementById('pincodeAvailability');
      if (pincodeContainer) {
        const pincodeCards = pincodeContainer.querySelectorAll('div[id^="pincode_"]');
        pincodeCards.forEach(card => {
          // Add Bootstrap card styling
          card.classList.add('card', 'mb-3');
          const header = document.createElement('div');
          header.classList.add('card-header');
          header.innerHTML = card.querySelector('h5').outerHTML;
          
          const body = document.createElement('div');
          body.classList.add('card-body');
          
          // Move all content except the h5 to the body
          Array.from(card.childNodes).forEach(node => {
            if (node.nodeName !== 'H5') {
              body.appendChild(node.cloneNode(true));
            }
          });
          
          // Clear the card and add the new structure
          card.innerHTML = '';
          card.appendChild(header);
          card.appendChild(body);
        });
      }
    }

    // Call after the pincodes are loaded
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(enhancePincodeUI, 1000);
    });
  </script>
</body>
</html>